<!DOCTYPE html>
<html>

<head>

  <title>queetings</title>

  <meta charset="UTF-8">

  <meta name="viewport"
        content="width=device-width, initial-scale=1">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cash/6.0.1/cash.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard-polyfill/2.8.6/clipboard-polyfill.js"></script>

  <script src="client.js"></script>

  <style>
  
    #sendToTelegram {
      background-image: url("https://telegram.org/img/t_logo.png");
      background-size: 60%;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    #layout {
      display: grid;
      position: absolute;
      width: 100%;
      height: 100%;
      left: 0;
      top: 0;
      justify-content: center;
      justify-items: center;
    }

    body {
      overflow: hidden;
    }

    nav {
      display: flex;
      flex-wrap: wrap;
      width: max-content;
      justify-content: center;
    }

    main {
      display: flex;
      height: 100%;
      width: 100%;
    }

    main.portrait {
      overflow-x: hidden;
      overflow-y: scroll;
      flex-wrap: wrap;
    }

    main.landscape {
      overflow-x: scroll;
      overflow-y: hidden;
      flex-wrap: nowrap;
    }

    aside {
      display: block;
      position: absolute;
      left: 0;
      bottom: 0;
    }

    input {
      padding: 0px;
      margin: 4px;
      height: 3em - 8px;
      width: max-content;
      min-width: min-content;
      border: none;
      border-bottom: 1px solid teal;
    }

    button {
      width: 3em;
      min-width: 3em;
      height: 3em;
      background: white;
      border: 2px teal solid;
      margin: 2px;
    }

  </style>

</head>

<body>

  <div id="layout">

    <nav>
      <button id="sendToTelegram"
              onclick="sendToTelegram()">&nbsp;</button>
      <button id="sendViaEmail"
              onclick="sendViaEmail()">ðŸ“§</button>
      <button id="copyToClipboard"
              onclick="copyToClipboard()">ðŸ”—</button>
    </nav>

    <main></main>

  </div>

  <aside></aside>

  <script>

  const n = 3;

  const orientations = { "landscape" : "portrait" , "portrait" : "landscape" }
  const dicts = { 
    "portrait": {
      "windowSizeName": "innerWidth",
      "sizeName": "width"
    },
    "landscape": {
      "windowSizeName": "innerHeight",
      "sizeName": "height"
    }
  }

  function resize() {
    const currentOrientation =
            window.innerHeight > window.innerWidth ?
              "portrait" :
              "landscape";

    const oppositeOrientation = orientations[currentOrientation];
    const { sizeName: sizeNameCurrent,
            windowSizeName: windowSizeNameCurrent }
             = dicts[currentOrientation]
    const { sizeName: sizeNameOpposite,
            windowSizeName: windowSizeNameOpposite }
             = dicts[oppositeOrientation]
    const windowCurrentSize = window[windowSizeNameCurrent]
    const windowOppositeSize = window[windowSizeNameOpposite]

    $("main > video").css(sizeNameCurrent, windowCurrentSize);
    $("main > video").css(sizeNameOpposite, '');
    $("main").removeClass(oppositeOrientation);
    $("main").addClass(currentOrientation);

    $("aside > video").css(sizeNameCurrent, `${windowCurrentSize * .20}px`);
    $("aside > video").css(sizeNameOpposite, '');

  }

  window.onresize = resize;
  
  </script>

  <script>

  function handleInputStream(stream) {
    console.log('handling input stream')
    const { id } = stream;
    if (document.getElementById(id)) {
      console.log('stream is already playin')
      return;
    }
    const video = Object.assign(document.createElement("video"), {
      id,
      autoplay: true,
      srcObject: stream
    })
    video.load()
    $("main").append(video)
    resize()
  }

  async function copyToClipboard() {
    const localStream = document.querySelector("aside > video").srcObject
    join(
      localStream,
      (url) => {
        const shareUrl = `${document.URL}?join=${encodeURI(url)}`
        const text = encodeURIComponent('join me')
        navigator.clipboard.writeText(url)
      },
      handleInputStream
    )
  }

  async function sendToTelegram() {
    const localStream = document.querySelector("aside > video").srcObject
    join(
      localStream,
      (url) => {
        const shareUrl = `${document.URL}?join=${encodeURI(url)}`
        const text = encodeURIComponent('join me')
        window.open(`https://telegram.me/share/url?url=${encodeURI(shareUrl)}`)
      },
      handleInputStream
    )
  }

  async function sendViaEmail() {
    const localStream = document.querySelector("aside > video").srcObject
    join(
      localStream,
      (url) => {
        const shareUrl = `${document.URL}?join=${encodeURI(url)}`
        // const text = encodeURIComponent('join me')
        window.open(`mailto:?body=${encodeURI(shareUrl)}`)
      },
      handleInputStream
    )
  }

  (async () => {

    const localStream = await navigator.mediaDevices.getUserMedia(
                          { video:true, audio: true }
                        )

    const video = Object.assign(document.createElement("video"), {
      muted:      true,
      autoplay:   true,
      srcObject:  localStream,
    });
    video.load();
    $("aside").append(video);

    const joinUrl = new URL(document.URL).searchParams.get("join")
    if (joinUrl) {
      accept(
        localStream,
        joinUrl,
        handleInputStream
      )
    }

    resize()

  })()

  </script>

</body>

</html>